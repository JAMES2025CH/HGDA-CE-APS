<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºé«”æ•™æ¡ˆç”Ÿæˆå™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨æ€æºé»‘é«”æˆ–ç³»çµ±é è¨­å­—é«”ä»¥ç¢ºä¿ä¸­æ–‡é¡¯ç¤ºå„ªç¾ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #eef2f8; /* æ›´æ·ºçš„èƒŒæ™¯è‰² */
        }
        /* å®šç¾©ä¸»è‰²èª¿ */
        .primary-color { background-color: #1e40af; } /* æ·±è—è‰² */
        .primary-text { color: #1e40af; } 
        .input-style {
            border: 2px solid #cbd5e1; /* æ·ºç°é‚Šæ¡† */
            transition: all 0.3s;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .input-style:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* çµ±ä¸€æ•™æ¡ˆåˆ—è¡¨é …ç›®çš„è¦–è¦ºé¢¨æ ¼ */
        .lesson-list-item, .note-list-item {
            padding: 0.75rem 1rem;
            border-left: 5px solid #60a5fa; /* è—è‰²å¼·èª¿é‚Š */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f7f9ff; /* æ·ºæ·ºçš„è—è‰²èƒŒæ™¯ */
            border-radius: 0.375rem;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .note-list-item strong {
            color: #1e40af; 
        }
        /* æ´»å‹•å¼•å°æŠ€å·§å°ˆç”¨æ¨£å¼ */
        .guidance-box {
            border: 1px solid #fdba74; /* æ©˜è‰²é‚Šæ¡† */
            background-color: #fff7ed; /* æ·ºæ©˜è‰²èƒŒæ™¯ */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            color: #9a3412; /* æ·±æ©˜è‰²æ–‡å­— */
        }
        .suggestion-chip {
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .music-recommendation {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            padding: 1rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
        }
        .music-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .music-item:last-child {
            border-bottom: none;
        }
        /* å‹•ä½œèªªæ˜æŠ˜ç–ŠæŒ‰éˆ•æ¨£å¼ */
        .collapse-btn {
            background-color: #4f46e5;
            color: white;
            padding: 10px 20px;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .collapse-btn:hover {
            background-color: #4338ca;
        }
        .collapse-icon {
            margin-right: 8px;
        }
        /* æ•™æ¡ˆå…§å®¹å®¹å™¨ */
        .lesson-plan-container {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .lesson-section-title {
            font-size: 1.5rem; 
            font-weight: 800; /* æ›´ç²—çš„å­—é«” */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #1e40af; 
            border-bottom: 3px solid #bfdbfe; /* æ›´æ˜é¡¯çš„åº•ç·š */
            padding-bottom: 6px;
        }
        .lesson-subsection-title {
            font-size: 1.25rem; 
            font-weight: 700; 
            margin-top: 1.25rem;
            color: #374151; 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto lesson-plan-container overflow-hidden">
        
        <!-- Header -->
        <header class="primary-color text-white p-6 md:p-8 -mx-1.5 -mt-1.5 rounded-t-lg shadow-md">
            <h1 class="3xl font-bold mb-1">ğŸ§  æ™ºé«”æ•™æ¡ˆç”ŸæˆåŠ©æ‰‹</h1>
            <p class="text-sm opacity-90">è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼ŒAI å°‡ä¾æ“šæ‚¨çš„å°ˆæ¥­è³‡æ–™åº«ç”Ÿæˆå¯¦ç”¨æ•™æ¡ˆã€‚ <span class="font-bold">(C) é„­æ™ºå® HGDA</span></p>
        </header>

        <!-- Input Section -->
        <section class="p-6 md:p-8 space-y-6 bg-white border-b border-slate-200">
            <h2 class="2xl font-semibold primary-text mb-4 border-l-4 border-indigo-500 pl-3">é¸æ“‡èª²ç¨‹è¨­è¨ˆè¦ç´ </h2>

            <!-- ä¸»é¡Œ (å¾è³‡æ–™åº«å»ºè­°ä¸­é¸æ“‡) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">1. æ´»å‹•ä¸»é¡Œ</label>
                    <select id="topic" class="input-style w-full p-3 rounded-lg text-gray-700 appearance-none bg-white">
                        <option value="">-- è«‹é¸æ“‡ä¸€å€‹ä¸»é¡Œ --</option>
                    </select>
                </div>
                <!-- ç›®æ¨™ (å¾æ‚¨çš„ç›®æ¨™ä¸­é¸æ“‡) -->
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-700 mb-1">2. ä¸»è¦è¨“ç·´ç›®æ¨™</label>
                    <select id="goal" class="input-style w-full p-3 rounded-lg text-gray-700 appearance-none bg-white">
                        <option value="">-- è«‹é¸æ“‡ä¸€å€‹ç›®æ¨™ --</option>
                    </select>
                </div>
                 <!-- è¼”å…· (é–‹æ”¾è¼¸å…¥) -->
                <div>
                    <label for="equipment" class="block text-sm font-medium text-gray-700 mb-1">3. ä½¿ç”¨çš„è¼”å…·</label>
                    <input type="text" id="equipment" value="ç„¡" placeholder="é è¨­: ç„¡ (å¯æ›´æ”¹ç‚ºå½ˆåŠ›å¸¶ã€ç‘œçˆçƒç­‰)" class="input-style w-full p-3 rounded-lg text-gray-700">
                </div>
            </div>

            <!-- è¼”å…·æ¨è–¦æŒ‰éˆ•å’Œå»ºè­° -->
            <div class="space-y-2">
                <button id="recommendBtn" class="bg-yellow-500 text-white font-bold text-sm py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 whitespace-nowrap flex items-center justify-center">
                    <span id="recommendBtnText">âœ¨ æ¨è–¦å‰µæ„è¼”å…·</span>
                    <div id="recommendLoading" class="loading-animation hidden"></div>
                </button>
                <div id="equipmentSuggestions" class="flex flex-wrap gap-2 text-sm min-h-[24px]">
                    <!-- è¼”å…·å»ºè­°é¡¯ç¤ºå€ -->
                </div>
            </div>
            

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <button id="generateBtn" class="w-full flex items-center justify-center primary-color text-white font-extrabold text-lg py-4 px-4 rounded-lg shadow-xl hover:bg-blue-800 transition duration-300">
                <div id="loadingIndicator" class="loading-animation hidden mr-2"></div>
                <span id="btnText">ğŸš€ ä¸€éµç”Ÿæˆæ•™æ¡ˆ</span>
            </button>

            <div id="error-message" class="text-red-600 text-sm mt-3 hidden bg-red-100 p-2 rounded-lg border border-red-300"></div>
        </section>

        <!-- Output Section -->
        <section class="p-6 md:p-8 bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="2xl font-semibold primary-text border-l-4 border-indigo-500 pl-3">æ•™æ¡ˆç”Ÿæˆçµæœ</h2>
                <div class="flex space-x-2">
                    <!-- è¤‡è£½æŒ‰éˆ• (åŸé…æ¨‚æŒ‰éˆ•å·²ç§»é™¤) -->
                    <button id="copyBtn" class="bg-green-500 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-300 hidden flex items-center justify-center">
                        ğŸ“‹ è¤‡è£½æ•™æ¡ˆå…§å®¹
                    </button>
                </div>
            </div>
            
            <div id="lessonPlanOutput" class="lesson-plan-container min-h-60 relative">
                <p class="text-gray-500 italic" id="placeholder-text">è¼¸å…¥æ•™æ¡ˆè¦ç´ ä¸¦é»æ“Šã€Œä¸€éµç”Ÿæˆæ•™æ¡ˆã€ä¾†ç”¢ç”Ÿæ‚¨çš„å°ˆå±¬æ™ºé«”é‹å‹•æ•™æ¡ˆã€‚</p>
                
                <div id="generatedContent" class="hidden"></div>

                <!-- å‹•ä½œèªªæ˜æŠ˜ç–ŠæŒ‰éˆ• -->
                <button id="toggleNotesBtn" class="collapse-btn w-full hidden">
                    <span class="collapse-icon">â¬‡ï¸</span> é¡¯ç¤ºå‹•ä½œèªªæ˜
                </button>

                <!-- å‹•ä½œæ•™ç·´è¨»è§£å€ (å¯æŠ˜ç–Šçš„å…§å®¹) -->
                <div id="notesContainer" class="mt-6 hidden">
                    <div id="notesOutput" class="text-gray-700 space-y-3">
                        <h3 class="lesson-section-title primary-text">å‹•ä½œèªªæ˜</h3> 
                        <div id="notesContent"></div>
                    </div>
                </div>

                <!-- è¤‡è£½æˆåŠŸæç¤º -->
                <div id="copySuccess" class="absolute top-0 right-0 m-4 px-3 py-1 bg-green-500 text-white rounded-md text-sm shadow-lg hidden opacity-0 transition-opacity duration-500">
                    âœ… è¤‡è£½æˆåŠŸï¼
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        // ====================================================================
        // æ ¸å¿ƒè³‡æ–™åº« (80% å…§å®¹ä¾†æº) - æ“´å……ç¯€æ…¶èˆ‡ç”Ÿæ´»ä¸»é¡Œ
        // ====================================================================
        const coreData = [
            // æ–°å¢ç¯€æ…¶ä¸»é¡Œ
            {
                name: "æ–°å¹´æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (æ–°å¹´)",
                goal: "è¤‡é›œå°ˆæ³¨åŠ›",
                equipment: "ç´…åŒ…/é­ç‚®åœ–å¡",
                description: "çµåˆæ–°å¹´èµ°æ˜¥ã€æ”¾é­ç‚®ã€é ˜ç´…åŒ…ç­‰å‹•ä½œï¼Œè¨“ç·´è‚¢é«”å”èª¿èˆ‡è¤‡é›œå°ˆæ³¨åŠ›ï¼Œå¢æ·»ç¯€æ…¶æ­¡æ¨‚ã€‚",
                action_set: ["èˆé¾èˆç… (é›™æ‰‹ç•«åœˆ)", "æ”¾é­ç‚® (é›™æ‰‹æ‹æ‰‹å‘ä¸‹å£“)", "æ‹œå¹´ä½œæ– (é›™æ‰‹èƒ¸å‰ä½œæ–)", "ç™¼ç´…åŒ… (é›™æ‰‹å‘å‰æ¨å‡º)"]
            },
            {
                name: "å°¾ç‰™æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (å°¾ç‰™)",
                goal: "åæ‡‰èƒ½åŠ›",
                equipment: "ç„¡",
                description: "æ¨¡æ“¬å¹´çµ‚èšæœƒã€æŠ½çã€è‡´è©ç­‰æ´»å‹•ï¼Œè¨“ç·´çŸ­æœŸè¨˜æ†¶èˆ‡åæ‡‰é€Ÿåº¦ã€‚",
                action_set: ["èˆ‰æ¯(å–®å­ä¸Šèˆ‰)", "æŠ½ç(é›™æ‰‹æŠ“å–)", "è‡´è©(å–®æ‰‹å‰ä¼¸)", "åŸåœ°è¸æ­¥"]
            },
            {
                name: "æ¸…æ˜æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (æ¸…æ˜)",
                goal: "é‚è¼¯åˆ¤æ–·",
                equipment: "ç„¡",
                description: "çµåˆæƒå¢“ã€è¸é’ã€æ”¾é¢¨ç®ç­‰å‹•ä½œï¼Œè¨“ç·´é—œç¯€æ´»å‹•åº¦ã€çŸ­æœŸè¨˜æ†¶å’Œé‚è¼¯åˆ¤æ–·ã€‚",
                action_set: ["æƒå¢“åˆå (é›™æ‰‹åˆå)", "å»è¸é’ (åŸåœ°è¸æ­¥)", "æ”¾é¢¨ç® (é›™æ‰‹æ¡æ‹³èˆ‰é«˜)", "è‰ä»”ç²¿ (å‰è‡‚æ—‹å‰æ—‹å¾Œ)"]
            },
            // æ—¢æœ‰ç¯€æ…¶ä¸»é¡Œ
            {
                name: "è–èª•æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (è–èª•)",
                goal: "çŸ­æœŸè¨˜æ†¶",
                equipment: "ç„¡",
                description: "çµåˆè–èª•æ¨¹ã€é€ç¦®ç‰©ã€å ±ä½³éŸ³ã€å”±è©©æ­Œç­‰å‹•ä½œï¼Œè¨“ç·´ä¸Šè‚¢è‚ŒåŠ›èˆ‡æŠ‘åˆ¶æ§åˆ¶èƒ½åŠ›ã€‚",
                action_set: ["è–èª•æ¨¹(é›™æ‰‹é«˜èˆ‰+æŠ¬è†)", "é€ç¦®ç‰©(é›™æ‰‹å‰æ¨+å‰é»)", "å ±ä½³éŸ³(é›™æ‰‹å´æ“º+å´é»)", "æ”¶ç¦®ç‰©(é›™æ‰‹ç’°æŠ±)"]
            },
            {
                name: "å†¬è‡³æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (å†¬è‡³)",
                goal: "å…¨èº«å”èª¿",
                equipment: "ç„¡",
                description: "ä»¥æ“æ¹¯åœ“ã€ç”œç±³ç³•ã€è–‘æ¯é´¨ã€ç‡‰æ’éª¨ç­‰å‹•ä½œç‚ºæ ¸å¿ƒï¼Œå¼·åŒ–å…¨èº«å”èª¿èˆ‡åæ‡‰é€Ÿåº¦ã€‚",
                action_set: ["æ“æ¹¯åœ“(é›™æ‰‹èƒ¸å‰ç¹åœˆ)", "ç”œç±³ç³•(é›™æ‰‹è‡‚ä¼¸ç›´åˆ‡å¡Š)", "ç¾Šè‚‰çˆ(å–®è…³æŠ¬è†+ä¸Šèˆ‰)", "ç‡‰æ’éª¨(é›™æ‰‹æ“´èƒ¸)"]
            },
            {
                name: "å…ƒå®µæ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (å…ƒå®µ)",
                goal: "çŸ­æœŸè¨˜æ†¶",
                equipment: "ç„¡",
                description: "5å€‹å£ä»¤å‹•ä½œï¼šè²·èœã€åšå…ƒå®µã€æ›ç‡ˆç± ã€è¸©é«˜è¹ºã€åƒæ¹¯åœ“ã€‚è¨“ç·´å‹•ä½œåˆ‡æ›èˆ‡é †åºè¨˜æ†¶ã€‚",
                action_set: ["å»è²·èœ(è¸æ­¥+å–®æ‰‹ç•«åœˆ)", "åšå…ƒå®µ(é›™æ‰‹ç•«åœˆ)", "æ›ç‡ˆç± (å–®æ‰‹ä¸Šèˆ‰)", "è¸©é«˜è¹º(æŠ¬è†)", "åƒæ¹¯åœ“(é›™æ‰‹ç’°æŠ±)"]
            },
            {
                name: "ç«¯åˆæ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (ç«¯åˆ)",
                goal: "è¤‡é›œå°ˆæ³¨åŠ›",
                equipment: "ç„¡",
                description: "çµåˆç«¯åˆæ–‡åŒ–è¨­è¨ˆçš„6å€‹å‹•ä½œï¼šç²½å­ã€é¾èˆŸã€è‰¾è‰ã€é¦™åŒ…ã€ç™½è›‡ã€é›„é»ƒã€‚é€²éšæŒ‘æˆ°ç‚ºåšä¸‹ä¸€å€‹æˆ–ä¸Šä¸€å€‹å‹•ä½œï¼Œè¨“ç·´è¨˜æ†¶èˆ‡é‚è¼¯åˆ¤æ–·ã€‚",
                action_set: ["ç²½å­(é›™æ‰‹å‰æ¨)", "é¾èˆŸ(é›™æ‰‹å´æ“º)", "è‰¾è‰(é›™æ‰‹é«˜èˆ‰)", "é¦™åŒ…(é›™æ‰‹ç¹åœˆ)", "è¸æ­¥"]
            },
            {
                name: "ä¸­ç§‹æ‹³",
                topic: "ç¯€æ…¶ä¸»é¡Œ (ä¸­ç§‹)",
                goal: "è¨˜æ†¶åŠ›,åæ‡‰èƒ½åŠ›",
                equipment: "ç„¡",
                description: "çµåˆéƒŠéŠã€è³æœˆã€æœˆé¤…ã€æŸšå­ã€çƒ¤è‚‰ã€èƒèŸ¹ã€‚åœ‹å°èªé›™èªè¨€å°æ‡‰å‹•ä½œï¼Œè¨“ç·´é•·çŸ­æœŸè¨˜æ†¶èˆ‡åæ‡‰ã€‚",
                action_set: ["æ‹œæ‹œ(åˆå)", "è³æœˆ(é›™æ‰‹ç•«åœ“)", "åƒæœˆé¤…(é›™æ‰‹èƒ¸å‰)", "åƒæŸšå­(é›™æ‰‹å´èˆ‰)", "åŸåœ°è¸æ­¥"]
            },
            // ç”Ÿæ´»æ‡‰ç”¨
            {
                name: "ADLç”Ÿæ´»åŠŸèƒ½æ‹³",
                topic: "ç”Ÿæ´»æ‡‰ç”¨",
                goal: "ç”Ÿæ´»ä¸Šçš„é‹ç”¨",
                equipment: "ç„¡/æ¤…å­",
                description: "å›æƒ³ä¸€æ—¥ç”Ÿæ´»å‹•ä½œ(åˆ·ç‰™ã€æ´—è‡‰ã€ç©¿è¡£ç­‰)ï¼Œè¨­è¨ˆä¸€é€£ä¸²å‹•ä½œè¨˜æ†¶ã€‚è¨“ç·´è¨˜æ†¶åŠ›èˆ‡è‚¢é«”å”èª¿ã€‚",
                action_set: ["åˆ·ç‰™(ä¸Šä¸‹æ“ºå‹•)", "æ´—è‡‰(ç•«åœˆ)", "ç©¿è¡£(ä¸Šèˆ‰ä¸‹æ‹‰)", "åƒé£¯(èƒ¸å‰ç¹åœˆ)", "åŸåœ°è¸æ­¥"]
            },
            {
                name: "ç¾é£Ÿå¥åº·æ“",
                topic: "ç”Ÿæ´»æ‡‰ç”¨",
                goal: "è¨˜æ†¶åŠ›,èªè¨€è¡¨é”",
                equipment: "ç„¡",
                description: "çµåˆå…­å¤§é£²é£Ÿé¡åˆ¥ï¼Œæ­é…å‹•ä½œå£ä»¤(ä¾‹å¦‚ï¼šæ°´æœä¸€é¤ä¸€æ‹³é ­)ï¼Œè¨“ç·´è¨˜æ†¶ã€åæ‡‰åŠèªè¨€è¡¨é”ã€‚",
                action_set: ["ç‰›å¥¶(è¼ªæµèˆ‰æ¯)", "æ°´æœ(è¼ªæµå‡ºæ‹³)", "é’èœ(æ“ŠæŒ)", "å…¨ç©€(éœ‡ç›ªæŒ)", "è¸æ­¥"]
            },
            // åŸºç¤é«”é©èƒ½
            {
                name: "å‡ºå»ç©",
                topic: "å¿ƒè‚º",
                goal: "è¤‡é›œå°ˆæ³¨åŠ›",
                equipment: "ç„¡",
                description: "æ¨¡æ“¬æ­ä¹˜å…¬è»Šã€é£›æ©Ÿç­‰å‹•ä½œï¼Œçµåˆç¤¾æœƒèªçŸ¥ã€çŸ­æœŸè¨˜æ†¶å’Œè¤‡é›œæ³¨æ„åŠ›è¨“ç·´ï¼Œè¦æ±‚å…¨ç¨‹è¸æ­¥ã€‚",
                action_set: ["è¸æ­¥", "å–®æ‰‹ä¸Šèˆ‰+è…¿ä¸ŠæŠ¬ (æ­å…¬è»Š)", "é›™è‡‚å´èˆ‰ (å¤§é£›æ©Ÿ)", "å–®è…³å‰é»+æ‰‹å‰æ¨ (æ­èˆ¹)"]
            },
            {
                name: "è“‹æˆ¿å­æ‹³",
                topic: "è‚ŒåŠ›",
                goal: "èªçŸ¥åŸ·è¡Œèƒ½åŠ›",
                equipment: "ç„¡/æ¤…å­",
                description: "åå§¿ä¸Šè‚¢è‚ŒåŠ›è¨“ç·´ï¼Œå£ä»¤åŒ…æ‹¬è“‹æˆ¿å­ã€æ‰“åœ°åŸºã€ç–Šç£šé ­ã€æ‰“æ°´æ³¥ã€æŠ¹ç‰†å£ã€‚å¼·èª¿è½å£ä»¤èˆ‡çœ‹å‹•ä½œçš„ç¨ç«‹åŸ·è¡Œã€‚",
                action_set: ["è“‹æˆ¿å­ (é›™æ‰‹ä¸Šèˆ‰)", "æ‰“åœ°åŸº (é›™æ‰‹äº¤å‰é–‹åˆ)", "ç–Šç£šé ­ (é›™æ‰‹èƒ¸å‰äº¤ç–Š)", "æ‰“æ°´æ³¥ (é›™æ‰‹å¤–æ—‹)"]
            },
            {
                name: "å½ˆåŠ›å¸¶5-æ¶æ•‘æé¾è›‹",
                topic: "å”èª¿",
                goal: "æ‰‹çœ¼å”èª¿",
                equipment: "å½ˆåŠ›å¸¶, æ°£çƒ, å°çƒ",
                description: "å–®äººæˆ–é›™äººä½¿ç”¨å½ˆåŠ›å¸¶æ’é–‹ï¼Œå°‡çƒæ”¾ç½®å…¶ä¸­ä¸¦å‚³éï¼Œè¨“ç·´ä¸Šè‚¢è‚ŒåŠ›ã€æ„ŸçŸ¥èƒ½åŠ›åŠæ‰‹çœ¼å”èª¿ã€‚",
                action_set: ["å–®äººæ’é–‹å½ˆåŠ›å¸¶", "é›™æ‰‹å”åŒé‹çƒ", "å‚³éçµ¦ä¸‹ä¸€ä½"]
            },
            {
                name: "æ°´æœæ‹³",
                topic: "è¨˜æ†¶",
                goal: "åæ‡‰èƒ½åŠ›",
                equipment: "ç„¡",
                description: "ç¤ºç¯„ä¸‰ç¨®æ°´æœå‹•ä½œåŠé—œä¿‚ï¼Œé€²è¡Œæ¯”å¤§æ¯”å¤šã€æ¯”å°‘æ¯”å°å•ç­”ã€‚é€²éšè¦æ±‚é€£çºŒå›ç­”ï¼Œå¼·åŒ–åæ‡‰åŠ›èˆ‡å°ˆæ³¨åŠ›ã€‚",
                action_set: ["è˜‹æœ (ç¡¬æ¢†æ¢†)", "é¦™è•‰ (è»Ÿè¶´è¶´)", "æ¡ƒå­ (ç´…å±è‚¡)", "è¸æ­¥"]
            },
            {
                name: "æ‹æ‰‹è¸æ­¥8ä¸‹å»",
                topic: "è¨ˆç®—",
                goal: "è¨ˆç®—èƒ½åŠ›",
                equipment: "ç„¡",
                description: "ä»¥8æ‹ç‚ºä¸€å¾ªç’°ï¼Œè€å¸«æ‹æ‰‹å­¸ç”Ÿå°æ‡‰è¸æ­¥ï¼Œæˆ–è€å¸«æ‹è¸æ··åˆï¼Œå­¸ç”Ÿæ¥çºŒå°æ‡‰ã€‚è¨“ç·´å°ˆæ³¨åŠ›èˆ‡è¨ˆç®—èƒ½åŠ›ã€‚",
                action_set: ["ç´”æ‹æ‰‹", "ç´”è¸æ­¥", "æ‹æ‰‹åŠ è¸æ­¥", "æ¥çºŒå°æ‡‰å‹•ä½œ"]
            }
        ];

        // æ ¸å¿ƒè¨“ç·´ç›®æ¨™ (å°æ‡‰ç›®æ¨™ä¸‹æ‹‰é¸å–®)
        const coreGoals = [
            "é«”é©èƒ½åŠèªçŸ¥åŠŸèƒ½",
            "ç”Ÿæ´»ä¸Šçš„é‹ç”¨",
            "å¤§è…¦åŠŸèƒ½å€åŸŸçš„æ”¹å–„"
        ];
        
        // ====================================================================
        // UI å…ƒç´ èˆ‡ç‹€æ…‹ç®¡ç†
        // ====================================================================
        const topicSelect = document.getElementById('topic');
        const goalSelect = document.getElementById('goal');
        const equipmentInput = document.getElementById('equipment');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const lessonPlanOutput = document.getElementById('lessonPlanOutput');
        const generatedContent = document.getElementById('generatedContent');
        const placeholderText = document.getElementById('placeholder-text');
        const errorMessage = document.getElementById('error-message');
        const copyBtn = document.getElementById('copyBtn');
        const copySuccess = document.getElementById('copySuccess');
        const notesContainer = document.getElementById('notesContainer'); // å¯æŠ˜ç–Šå®¹å™¨
        const notesContent = document.getElementById('notesContent'); 
        const recommendBtn = document.getElementById('recommendBtn');
        const recommendBtnText = document.getElementById('recommendBtnText');
        const recommendLoading = document.getElementById('recommendLoading');
        const equipmentSuggestions = document.getElementById('equipmentSuggestions');
        const toggleNotesBtn = document.getElementById('toggleNotesBtn');
        
        // åŸé…æ¨‚ç›¸é—œå…ƒç´ å·²ç§»é™¤
        // const recommendMusicBtn = document.getElementById('recommendMusicBtn');
        // const musicOutput = document.getElementById('musicOutput');
        // const musicContent = document.getElementById('musicContent');

        let lastGeneratedMarkdown = ""; // å„²å­˜æ•™æ¡ˆä¸»é«”åŸå§‹ Markdown æ–‡å­—
        let lastGeneratedNotes = ""; // å„²å­˜å°ˆæ¥­è¨»è§£åŸå§‹æ–‡å­—
        let lastGeneratedMusic = ""; // å„²å­˜éŸ³æ¨‚æ¨è–¦ç´”æ–‡å­— (å·²ç§»é™¤ï¼Œä½†ä¿ç•™è®Šæ•¸æ–¹ä¾¿è¤‡è£½åŠŸèƒ½)

        // ====================================================================
        // æ—¥æœŸèˆ‡é¸æ“‡å™¨å¡«å……é‚è¼¯
        // ====================================================================

        function getMonthDifference(currentMonth, targetMonth) {
            let diff = targetMonth - currentMonth;
            if (diff < 0) {
                diff += 12;
            }
            return diff;
        }

        function sortTopicsByProximity(uniqueTopics) {
            const now = new Date();
            const currentMonth = now.getMonth(); 
            const currentDay = now.getDate(); 

            const holidayMonths = {
                // æœˆä»½ (0-11), æ—¥æœŸ
                "ç¯€æ…¶ä¸»é¡Œ (æ–°å¹´)": [0, 25], 
                "ç¯€æ…¶ä¸»é¡Œ (å°¾ç‰™)": [0, 20],   
                "ç¯€æ…¶ä¸»é¡Œ (æ¸…æ˜)": [3, 5],    
                "ç¯€æ…¶ä¸»é¡Œ (è–èª•)": [11, 25],
                "ç¯€æ…¶ä¸»é¡Œ (å†¬è‡³)": [11, 22],
                "ç¯€æ…¶ä¸»é¡Œ (å…ƒå®µ)": [1, 15],
                "ç¯€æ…¶ä¸»é¡Œ (ç«¯åˆ)": [5, 5],
                "ç¯€æ…¶ä¸»é¡Œ (ä¸­ç§‹)": [8, 15],
            };

            const topicScores = uniqueTopics.map(topic => {
                if (topic.startsWith("ç¯€æ…¶ä¸»é¡Œ")) {
                    const [targetMonth, targetDay] = holidayMonths[topic] || [0, 1];
                    let score = getMonthDifference(currentMonth, targetMonth);

                    if (targetMonth === currentMonth) {
                        score = (targetDay >= currentDay) ? 0 : 12;
                    }
                    
                    return { topic, score: score - 100 };
                }
                return { topic, score: 100 };
            }).sort((a, b) => {
                if (a.score !== b.score) {
                    return a.score - b.score;
                }
                return a.topic.localeCompare(b.topic);
            });

            return topicScores.map(item => item.topic);
        }

        function populateSelectors() {
            const uniqueTopics = [...new Set(coreData.map(item => item.topic))];
            const sortedTopics = sortTopicsByProximity(uniqueTopics);
            
            sortedTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            coreGoals.forEach(goal => {
                const option = document.createElement('option');
                option.value = goal;
                option.textContent = goal;
                goalSelect.appendChild(option);
            });
        }
        
        populateSelectors();


        // ====================================================================
        // Gemini API å‘¼å«æ ¸å¿ƒå‡½æ•¸ (ç²¾ç°¡)
        // ====================================================================
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        
        // ğŸš¨ å…§åµŒ API é‡‘é‘° ğŸš¨
        const API_KEY = "AIzaSyDSZcE7HIKUrKizouoQy0OrLoA8TChN7pY"; 

        async function callStructuredApi(userQuery, generationConfig, systemInstruction = null) {
            if (!API_KEY || API_KEY === "") {
                throw new Error("API é‡‘é‘°æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­ API_KEY è®Šæ•¸ã€‚");
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: generationConfig
            };
            
            if (systemInstruction) {
                payload.systemInstruction = systemInstruction;
            }

            const maxRetries = 5;
            let delay = 1000;
            const apiUrlWithKey = `${API_URL}?key=${API_KEY}`;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrlWithKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Request Failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonText) {
                         // å˜—è©¦è§£æ JSON
                        try {
                            const parsed = JSON.parse(jsonText);
                            return parsed; // æˆåŠŸè§£æï¼Œè¿”å›
                        } catch (e) {
                            // å¦‚æœè§£æå¤±æ•—ï¼Œè¦–ç‚ºæ¨¡å‹è¼¸å‡ºæ ¼å¼éŒ¯èª¤ï¼Œç¹¼çºŒé‡è©¦
                            if (i < maxRetries - 1) {
                                console.warn(`JSON parsing failed on attempt ${i + 1}. Retrying...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 2;
                                continue; 
                            }
                            throw new Error("æ¨¡å‹è¿”å›äº†ç„¡æ•ˆçš„ JSON æ ¼å¼ã€‚");
                        }
                    }

                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw new Error("API è«‹æ±‚æˆåŠŸä½†å…§å®¹ç‚ºç©ºï¼Œå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ã€‚");
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API è«‹æ±‚å¤±æ•—æˆ–é€£ç·šéŒ¯èª¤: ${error.message}`);
                    }
                }
            }
            throw new Error("é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼ŒAPI è«‹æ±‚å¤±æ•—ã€‚");
        }

        // ====================================================================
        // UI ç‹€æ…‹è¼”åŠ©å‡½æ•¸
        // ====================================================================

        function setUiState(isGenerating, targetElement, buttonText) {
            targetElement.disabled = isGenerating;
            
            const loadingDiv = targetElement.querySelector('.loading-animation') || targetElement.querySelector('#recommendLoading');
            const textSpan = targetElement.querySelector('span') || targetElement;
            
            if (isGenerating) {
                targetElement.classList.add('opacity-70', 'cursor-not-allowed');
                textSpan.classList.add('hidden');
                if (loadingDiv) loadingDiv.classList.remove('hidden');
                targetElement.textContent = buttonText;
                if (loadingDiv) targetElement.prepend(loadingDiv);
            } else {
                targetElement.classList.remove('opacity-70', 'cursor-not-allowed');
                if (loadingDiv) loadingDiv.classList.add('hidden');
                textSpan.classList.remove('hidden');
                targetElement.textContent = buttonText;
            }
        }

        // ====================================================================
        // å‹•ä½œèªªæ˜æŠ˜ç–ŠåŠŸèƒ½
        // ====================================================================

        toggleNotesBtn.addEventListener('click', () => {
            const isHidden = notesContainer.classList.contains('hidden');
            const icon = toggleNotesBtn.querySelector('.collapse-icon');

            if (isHidden) {
                notesContainer.classList.remove('hidden');
                toggleNotesBtn.textContent = 'â–² éš±è—å‹•ä½œèªªæ˜';
                icon.textContent = 'â–²';
            } else {
                notesContainer.classList.add('hidden');
                toggleNotesBtn.textContent = 'â¬‡ï¸ é¡¯ç¤ºå‹•ä½œèªªæ˜';
                icon.textContent = 'â¬‡ï¸';
            }
            // é€™è£¡ä¸éœ€è¦ toggleNotesBtn.prepend(icon);ï¼Œå› ç‚º textContent æœƒé‡ç½®å…ƒç´ å…§å®¹
        });

        // ====================================================================
        // è¤‡è£½åŠŸèƒ½ - ä¿®æ­£ç‚º execCommand('copy')
        // ====================================================================

        copyBtn.addEventListener('click', () => {
            // åˆä½µæ•™æ¡ˆä¸»é«”ã€å‹•ä½œèªªæ˜å’ŒéŸ³æ¨‚æ¨è–¦ï¼Œä¸¦ç§»é™¤ Markdown æ ¼å¼
            let combinedContent = lastGeneratedMarkdown;
            if (lastGeneratedNotes) {
                // åˆä½µå‹•ä½œèªªæ˜åˆ°è¤‡è£½å…§å®¹ä¸­
                combinedContent += `\n\n--- å‹•ä½œèªªæ˜ ---\n${lastGeneratedNotes}`;
            }
            // lastGeneratedMusic å·²ç§»é™¤ï¼Œä¸å½±éŸ¿æ­¤è™•ã€‚

            // 1. ç§»é™¤ Markdown ç¬¦è™Ÿ
            let plainText = combinedContent
                .replace(/^#+\s/gm, '\n')         // è½‰æ› # æ¨™é¡Œç‚ºç©ºè¡Œï¼Œå¢åŠ åˆ†æ®µ
                .replace(/\*\*(.*?)\*\*/g, '$1') // ç§»é™¤ **ç²—é«”** ç¬¦è™Ÿ
                .replace(/^- /gm, ' - ')        // è½‰æ›åˆ—è¡¨ç¬¦è™Ÿ
                .replace(/##\s*/g, '')          // ç§»é™¤äºŒç´šæ¨™é¡Œç¬¦è™Ÿ
                .replace(/\n\s*\n/g, '\n\n')    // æ¨™æº–åŒ–å¤šé¤˜çš„ç©ºè¡Œ
                .trim();
            
            // 2. è™•ç†è¤‡è£½
            try {
                // ä½¿ç”¨ document.execCommand('copy') ä¾†ç¢ºä¿åœ¨ iFrame æˆ–å—é™ç’°å¢ƒä¸‹çš„ç›¸å®¹æ€§
                const textarea = document.createElement('textarea');
                textarea.value = plainText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                // é¡¯ç¤ºæˆåŠŸæç¤º
                copySuccess.classList.remove('hidden');
                copySuccess.classList.add('opacity-100');
                setTimeout(() => {
                    copySuccess.classList.remove('opacity-100');
                    setTimeout(() => { copySuccess.classList.add('hidden'); }, 500); 
                }, 1500);

            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                // å³ä½¿ execCommand å¤±æ•—ï¼Œä¹Ÿæç¤ºä½¿ç”¨è€…å¯ä»¥æ‰‹å‹•è¤‡è£½
                errorMessage.textContent = 'è¤‡è£½å¤±æ•—ã€‚è«‹å˜—è©¦æ‰‹å‹•é¸å–æ•™æ¡ˆå…§å®¹ã€‚';
                errorMessage.classList.remove('hidden');
            }
        });

        // ====================================================================
        // æ–°å¢åŠŸèƒ½ 1: è¼”å…·å‰µæ„æ¨è–¦ (å·²ä¿®å¾©)
        // ====================================================================

        recommendBtn.addEventListener('click', async () => {
            const topic = topicSelect.value;
            const goal = goalSelect.value;

            if (!topic || !goal) {
                errorMessage.textContent = "è«‹å…ˆé¸æ“‡ã€Œæ´»å‹•ä¸»é¡Œã€å’Œã€Œä¸»è¦è¨“ç·´ç›®æ¨™ã€æ‰èƒ½æ¨è–¦è¼”å…·ï¼";
                errorMessage.classList.remove('hidden');
                return;
            } else {
                errorMessage.classList.add('hidden');
            }

            // ğŸ¯ ä¿®æ­£é»ï¼šåœ¨æ“ä½œ toggleNotesBtn å‰ï¼Œå…ˆåˆ¤æ–·å®ƒæ˜¯å¦å­˜åœ¨
            if (toggleNotesBtn) {
                // é‡ç½®ç‹€æ…‹ï¼šéš±è—å…§å®¹ï¼Œä¸¦ç¢ºä¿æŒ‰éˆ•æ–‡å­—ç‚ºæ”¶åˆç‹€æ…‹
                notesContainer.classList.add('hidden');
                toggleNotesBtn.textContent = 'â¬‡ï¸ é¡¯ç¤ºå‹•ä½œèªªæ˜';
                const icon = toggleNotesBtn.querySelector('.collapse-icon');
                if (icon) icon.textContent = 'â¬‡ï¸';
            }


            setUiState(true, recommendBtn, "AI æ­£åœ¨æ€è€ƒä¸­...");
            equipmentSuggestions.innerHTML = `<p class="text-gray-500">æ­£åœ¨æ€è€ƒå‰µæ„è¼”å…·ä¸­...</p>`;

            const userQuery = `æ ¹æ“šä¸»é¡Œ: ${topic} å’Œè¨“ç·´ç›®æ¨™: ${goal}ï¼Œè«‹æ¨è–¦ 3 å€‹å®¹æ˜“å–å¾—ã€å®‰å…¨æ€§é«˜ä¸”å¯Œæœ‰å‰µæ„çš„è¼”åŠ©å™¨æï¼ˆä¾‹å¦‚ï¼šå ±ç´™ã€æ¯›å·¾ã€ç‘œçˆçƒï¼‰ã€‚`;
            const schema = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "suggestions": {
                            type: "ARRAY",
                            items: { type: "STRING" }
                        }
                    },
                    required: ["suggestions"]
                }
            };
            
            try {
                const result = await callStructuredApi(userQuery, schema);
                
                if (result && result.suggestions) {
                    equipmentSuggestions.innerHTML = '';
                    result.suggestions.forEach(suggestion => {
                        const chip = document.createElement('span');
                        chip.className = 'suggestion-chip bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium cursor-pointer hover:bg-yellow-200';
                        chip.textContent = suggestion;
                        chip.onclick = () => {
                            equipmentInput.value = suggestion;
                            equipmentSuggestions.innerHTML = ''; 
                        };
                        equipmentSuggestions.appendChild(chip);
                    });
                } else {
                     equipmentSuggestions.innerHTML = `<p class="text-red-500">âŒ æœªèƒ½å–å¾—è¼”å…·æ¨è–¦ã€‚</p>`;
                }
            } catch (error) {
                equipmentSuggestions.innerHTML = `<p class="text-red-500">âŒ è¼”å…·æ¨è–¦å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</p>`;
            } finally {
                setUiState(false, recommendBtn, "âœ¨ æ¨è–¦å‰µæ„è¼”å…·");
            }
        });


        // ä¸»è¦é»æ“Šç”Ÿæˆäº‹ä»¶
        generateBtn.addEventListener('click', async () => {
            // æ¯æ¬¡é»æ“Šå…ˆæ¸…é™¤éŒ¯èª¤æç¤ºï¼Œé˜²æ­¢èˆŠéŒ¯èª¤å¹²æ“¾
            errorMessage.classList.add('hidden');

            const topic = topicSelect.value;
            const goal = goalSelect.value;
            const equipment = equipmentInput.value.trim();

            if (!topic || !goal || !equipment) {
                errorMessage.textContent = "è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½ï¼ˆä¸»é¡Œã€ç›®æ¨™ã€è¼”å…·ï¼‰éƒ½å·²å¡«å¯«æˆ–é¸æ“‡ï¼";
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // éš±è—è¼”åŠ©æŒ‰éˆ•å’Œä¸Šæ¬¡çµæœ
            copyBtn.classList.add('hidden');
            notesContainer.classList.add('hidden');
            toggleNotesBtn.classList.add('hidden');
            
            lastGeneratedMarkdown = ""; 
            lastGeneratedNotes = ""; 
            lastGeneratedMusic = "";
            
            // ğŸ¯ ä¿®æ­£é»ï¼šåœ¨æ“ä½œæŒ‰éˆ•ç‹€æ…‹å‰å…ˆæª¢æŸ¥å…¶æ˜¯å¦å­˜åœ¨
            if (toggleNotesBtn) {
                toggleNotesBtn.textContent = 'â¬‡ï¸ é¡¯ç¤ºå‹•ä½œèªªæ˜';
                const icon = toggleNotesBtn.querySelector('.collapse-icon');
                if(icon) icon.textContent = 'â¬‡ï¸';
            }


            // 1. ç¯©é¸è³‡æ–™åº« (80% å…§å®¹)
            let filteredPlans = coreData.filter(plan => 
                plan.topic === topic && plan.goal.includes(goal.substring(0, 4))
            );

            if (filteredPlans.length === 0) {
                 filteredPlans = coreData.filter(plan => plan.topic === topic);
            }
            
            if (filteredPlans.length === 0) {
                filteredPlans.push(coreData.find(p => p.name === "å‡ºå»ç©")); 
                errorMessage.textContent = `è­¦å‘Šï¼šæ‰¾ä¸åˆ°å®Œå…¨ç¬¦åˆçš„ä¸»é¡Œèˆ‡ç›®æ¨™ï¼Œå·²ä½¿ç”¨ã€Œ${filteredPlans[0].name}ã€ç‚ºåŸºåº•æ•™æ¡ˆã€‚`;
                errorMessage.classList.remove('hidden');
            }

            const basePlan = filteredPlans[Math.floor(Math.random() * filteredPlans.length)];
            
            const lessonPlanCoreData = {
                Base_Name: basePlan.name,
                Selected_Topic: topic,
                Selected_Goal: goal,
                Selected_Equipment: equipment,
                Base_Description: basePlan.description,
                Base_Actions: basePlan.action_set,
                Required_Format_Rules: "æš–èº«, ä¸»é¡Œæ´»å‹•(åˆéš/é€²éš1-é«”é©èƒ½/é€²éš2-èªçŸ¥è² è·/æ´»å‹•å¼•å°å°æŠ€å·§), ç·©å’Œé‹å‹•"
            };
            
            // AI ç”Ÿæˆçš„ç³»çµ±æŒ‡ä»¤
            const systemInstruction = {
                 parts: [{ text: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ã€Œæ™ºé«”é‹å‹•ã€æ•™æ¡ˆè¨­è¨ˆå¸«ï¼Œè«‹åš´æ ¼éµå¾ªä»¥ä¸‹è¦æ±‚ï¼š
                    1. æ ¹æ“šæä¾›çš„æ•™æ¡ˆæ ¸å¿ƒå…§å®¹ï¼ˆLesson Plan Core Dataï¼‰ï¼Œå°‡å…¶æ“´å……ç‚ºä¸€å€‹å®Œæ•´çš„é‹å‹•æ•™æ¡ˆã€‚
                    2. æ•™æ¡ˆçš„æ´»å‹•å‰µæ„å¿…é ˆæœ‰ 80% ä¾æ“š Core Dataï¼Œä½ çš„ä»»å‹™æ˜¯æä¾› 20% çš„èªæ³•ä¿®é£¾ã€æƒ…å¢ƒåŒ…è£å’Œå°ˆæ¥­åº¦æå‡ã€‚
                    3. **[æ•™æ¡ˆæµç¨‹ç°¡æ½”åŒ–è¦æ±‚]**ï¼šç‚ºäº†æå‡ç€è¦½é€Ÿåº¦ï¼Œåœ¨ **# æš–èº«**ã€**## åˆéšæ´»å‹•** å’Œ **## é€²éš 1 å‹ (é«”é©èƒ½)** é€™ä¸‰å€‹æ®µè½ä¸­ï¼Œå…§å®¹**åªèƒ½**åŒ…å«**é‹å‹•å‹•ä½œçš„æ¨™é¡Œåˆ—è¡¨**ï¼ˆä½¿ç”¨ Markdown åˆ—è¡¨ -ï¼‰ï¼Œ**åš´ç¦**ç”Ÿæˆä»»ä½•å‹•ä½œçš„èªªæ˜ç´°ç¯€æˆ–åŸ·è¡Œè¦é ˜ã€‚
                    4. **[å‹•ä½œèªªæ˜é›†ä¸­åŒ–è¦æ±‚]**ï¼šæ‰€æœ‰å‹•ä½œçš„æ“ä½œç´°ç¯€ã€åŸ·è¡Œè¦é ˜ã€è‚Œç¾¤å’Œæ³¨æ„äº‹é …ï¼Œå¿…é ˆ**å…¨éƒ¨**é›†ä¸­åœ¨ 'instruction_notes' æ¬„ä½ä¸­ï¼Œä¸¦ä»¥ **ç²—é«”æ¨™é¡Œ** å€åˆ†ã€‚
                    5. **[é‹å‹•é‡åš´æ ¼çµæ§‹åŒ–]**ï¼š
                       - **åˆéšæ´»å‹• (Basic)**: å…§å®¹å¿…é ˆåŒ…å«**4 å€‹é‹å‹•å‹•ä½œæ¨™é¡Œ**ã€‚
                       - **é€²éš 1 å‹ (é«”é©èƒ½)**: å¿…é ˆä¾æ“šåˆéšçš„å‹•ä½œï¼Œè¨­è¨ˆ**4 å€‹å»¶ä¼¸æˆ–å¼·åŒ–çš„é«”é©èƒ½å‹•ä½œæ¨™é¡Œ**ã€‚
                    6. **[è¼”å…·é‡æ§‹æ ¸å¿ƒè¦å‰‡]**ï¼šå¦‚æœ 'Selected_Equipment' ä¸æ˜¯ 'ç„¡'ï¼Œå‰‡ä½ å¿…é ˆå°‡æ•™æ¡ˆçš„ä¸»é¡Œæ´»å‹•å’Œæš–èº«å‹•ä½œ**å®Œå…¨åœç¹è©²è¼”å…·çš„ç‰¹æ€§** (ä¾‹å¦‚ï¼Œå¦‚æœè¼”å…·æ˜¯å ±ç´™ï¼Œæ´»å‹•å¿…é ˆæ˜¯ 'æ‰å ±ç´™'ã€'å¹³è¡¡é ‚å ±ç´™' ç­‰) é€²è¡Œé‡æ–°è¨­è¨ˆï¼Œä»¥é”åˆ° 'Selected_Goal'ã€‚æ•™æ¡ˆçš„å‹•ä½œé›†åˆæ‡‰å–ä»£ Base_Actionsã€‚
                    7. **[æ–°æ ¼å¼è¦æ±‚]** æ•™æ¡ˆå¿…é ˆåŒ…å«ä»¥ä¸‹å››å€‹ä¸»è¦æ®µè½ï¼ˆä½¿ç”¨ Markdown æ¨™é¡Œï¼‰ï¼š
                       - **# èª²ç¨‹ä¸»é¡Œ (4~8 å­—æ¨™é¡Œ)**
                       - **# æš–èº«**ï¼šå…§å®¹å¿…é ˆåŸºæ–¼ä¸»é¡Œæ´»å‹•çš„ä¸»è¦å‹•ä½œï¼Œç”¨æ–¼ä½å¼·åº¦ç†±èº«ã€‚
                       - **# ä¸»é¡Œæ´»å‹•**ï¼šæ­¤æ®µè½å¿…é ˆåŒ…å«å››å€‹å­æ®µè½ï¼ˆä½¿ç”¨ Markdown äºŒç´šæ¨™é¡Œï¼Œä¾‹å¦‚ '## åˆéšæ´»å‹•'ï¼‰ï¼š
                         - **åˆéšæ´»å‹•**ï¼šåŸºæœ¬å‹•ä½œç·´ç¿’ã€‚
                         - **é€²éš 1 å‹ (é«”é©èƒ½)**ï¼šç›®æ¨™ç‚ºæé«˜é«”é©èƒ½å¼·åº¦ã€å‹•ä½œçµ„æ•¸æˆ–æ™‚é–“ã€‚
                         - **é€²éš 2 å‹ (èªçŸ¥è² è·)**ï¼šç›®æ¨™ç‚ºæé«˜èªçŸ¥é›£åº¦ã€é›™é‡ä»»å‹™æˆ–åæ‡‰é€Ÿåº¦ï¼ˆå¦‚åå‘æŒ‡ä»¤ã€æ•¸å­—è¨ˆç®—ï¼‰ã€‚
                         - **æ´»å‹•å¼•å°å°æŠ€å·§**ï¼šé€™æ®µå¿…é ˆèªªæ˜é‡å° CDR 0.5 (æ¥µè¼•åº¦) å’Œ CDR 1 (è¼•åº¦) èªçŸ¥éšœç¤™æ‚£è€…çš„å¼•å°æ–¹å¼åŠå¼•å°èªã€‚
                       - **# ç·©å’Œé‹å‹•**ï¼šå…§å®¹å¿…é ˆæ˜¯é«”é©èƒ½ç·©å’Œé‹å‹•å’Œä¼¸å±•ã€‚
                    8. å¿…é ˆè¼¸å‡ºåŒ…å«å…©å€‹ Markdown å­—æ®µçš„ JSONï¼š
                       a) 'lesson_plan': å®Œæ•´çš„æ•™æ¡ˆå…§å®¹ï¼Œä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¸¦åŒ…å«ä¸Šè¿°æ‰€æœ‰æ®µè½ã€‚
                       b) 'instruction_notes': å¿…é ˆä»¥**é‹å‹•æ•™ç·´**çš„è§’åº¦ï¼Œé‡å°æ•™æ¡ˆä¸­çš„æ‰€æœ‰å‹•ä½œï¼Œæä¾›è©³ç´°ã€å°ˆæ¥­çš„åŸ·è¡Œè¦é ˜ã€ç›®æ¨™è‚Œç¾¤ã€å‹•ä½œè®ŠåŒ–æˆ–æ³¨æ„äº‹é …ã€‚æ¯å€‹æ¬¡ä¸»é¡Œæ¨™é¡Œè«‹ä½¿ç”¨ Markdown **ç²—é«”**æ¨™ç¤ºï¼Œæ®µè½é–“ç©ºä¸€è¡Œã€‚
                    9. è¼¸å‡ºçµæœå¿…é ˆæ˜¯ JSON æ ¼å¼ï¼ŒåŒ…å« 'lesson_plan' å’Œ 'instruction_notes' å…©å€‹å­—æ®µã€‚` 
                }]
            };

            const userQuery = `è«‹æ ¹æ“šä¸»é¡Œ: ${topic}, ç›®æ¨™: ${goal}, è¼”å…·: ${equipment}ï¼Œä¸¦ä»¥æ ¸å¿ƒæ•™æ¡ˆã€Œ${basePlan.name}ã€ç‚ºåŸºåº•ï¼Œç”Ÿæˆä¸€å€‹ç¬¦åˆæŒ‡å®šæ ¼å¼çš„æ•™æ¡ˆã€‚`;
            
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "lesson_plan": { type: "STRING" },
                        "instruction_notes": { type: "STRING" }
                    },
                    required: ["lesson_plan", "instruction_notes"]
                }
            };


            // 2. è¨­å®š UI ç‹€æ…‹
            setUiState(true, generateBtn, "AI æ­£åœ¨ç”Ÿæˆæ•™æ¡ˆä¸­...");
            placeholderText.classList.add('hidden');
            generatedContent.classList.add('hidden');
            lessonPlanOutput.innerHTML = `<div class="text-center p-8">
                <div class="loading-animation mx-auto border-4 border-blue-200 border-t-blue-500 w-10 h-10"></div>
                <p class="mt-4 text-blue-500">æ­£åœ¨èª¿ç”¨å°ˆæ¥­è³‡æ–™åº«ä¸¦é€²è¡ŒAIå‰µæ„æ½¤é£¾...</p>
            </div>`;


            // 3. å‘¼å« Gemini API é€²è¡Œ 20% æ ¼å¼åŒ–èˆ‡æ½¤é£¾
            try {
                const result = await callStructuredApi(userQuery, generationConfig, systemInstruction);
                
                const text = result.lesson_plan || "";
                const notes = result.instruction_notes || "";

                // å„²å­˜åŸå§‹ Markdown æ–‡æœ¬å’Œè¨»è§£
                lastGeneratedMarkdown = text;
                lastGeneratedNotes = notes;

                // 4. é¡¯ç¤ºæ•™æ¡ˆä¸»é«”
                generatedContent.innerHTML = formatMarkdownToHtml(text);
                generatedContent.classList.remove('hidden');
                lessonPlanOutput.innerHTML = ''; // æ¸…ç©º loading æç¤º
                lessonPlanOutput.appendChild(generatedContent);

                // 5. é¡¯ç¤ºå°ˆæ¥­æ•™ç·´è¨»è§£ (Instruction Notes)
                if (notes) {
                    notesContent.innerHTML = formatNotesMarkdownToHtml(notes);
                    toggleNotesBtn.classList.remove('hidden');
                    // ç¢ºä¿æŒ‰éˆ•å’Œå®¹å™¨è¢«é‡æ–°é™„åŠ 
                    lessonPlanOutput.appendChild(toggleNotesBtn); 
                    lessonPlanOutput.appendChild(notesContainer); 
                }

                // 6. é¡¯ç¤ºè¼”åŠ©æŒ‰éˆ•
                copyBtn.classList.remove('hidden');
                // ç§»é™¤ recommendMusicBtn çš„é¡¯ç¤ºé‚è¼¯

            } catch (error) {
                console.error("ç”ŸæˆéŒ¯èª¤:", error);
                errorMessage.textContent = error.message || "æ•™æ¡ˆç”Ÿæˆéç¨‹ä¸­ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤ã€‚";
                lessonPlanOutput.innerHTML = `<p class="text-red-500 p-4">âŒ éŒ¯èª¤ï¼šç„¡æ³•ç”Ÿæˆæ•™æ¡ˆã€‚è«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥æˆ–ç¢ºèªé‡‘é‘°å·²æ­£ç¢ºè¨­å®šã€‚</p>`;
                errorMessage.classList.remove('hidden');
            } finally {
                // æ¢å¾© UI ç‹€æ…‹
                setUiState(false, generateBtn, "ğŸš€ ä¸€éµç”Ÿæˆæ•™æ¡ˆ");
            }
        });

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ Markdown æ ¼å¼åŒ–ç‚º HTML (æ•™æ¡ˆä¸»é«”)
        function formatMarkdownToHtml(markdown) {
            if (typeof markdown !== 'string') {
                return '<p class="text-red-500">âŒ ç„¡æ³•é¡¯ç¤ºæ•™æ¡ˆå…§å®¹ï¼ŒAPI å›å‚³çš„è³‡æ–™æ ¼å¼ç„¡æ•ˆã€‚</p>';
            }

            let html = markdown;
            // è™•ç† # æ¨™é¡Œ (ä¸»è¦æ®µè½: èª²ç¨‹ä¸»é¡Œ, æš–èº«, ä¸»é¡Œæ´»å‹•, ç·©å’Œé‹å‹•)
            html = html.replace(/^#\s*(.*)$/gm, '<h1 class="lesson-section-title">$1</h1>');
            
            // è™•ç† ## æ¨™é¡Œ (å­æ®µè½: åˆéš, é€²éš 1/2 å‹, æ´»å‹•å¼•å°å°æŠ€å·§)
            html = html.replace(/^##\s*(.*)$/gm, '<h2 class="lesson-subsection-title">$1</h2>');

            // è™•ç†ç²—é«” (å¼·èª¿é‡é»)
            html = html.replace(/\*\*(.*?)\*\*/g, '<span class="font-extrabold text-blue-700">$1</span>');
            
            // è™•ç† æ´»å‹•å¼•å°å°æŠ€å·§ å…§å®¹ (ä½¿ç”¨å°ˆé–€çš„æç¤ºæ¡†æ¨£å¼)
            html = html.replace(/(## æ´»å‹•å¼•å°å°æŠ€å·§\s*[\s\S]*?)($|# )/g, (match, p1, p2) => {
                const content = p1.replace(/## æ´»å‹•å¼•å°å°æŠ€å·§\s*/, '').trim();
                const contentHtml = content.split('\n').map(line => {
                    if (line.trim().startsWith('- ')) {
                        // ç§»é™¤ - ç¬¦è™Ÿä¸¦ä¿ç•™å…§å®¹ï¼Œä½¿ç”¨åˆ—è¡¨æ¨£å¼
                        return `<div class="text-sm mt-1">${line.substring(2).trim()}</div>`;
                    } else if (line.trim()) {
                        return `<p class="mt-2 mb-1">${line.trim()}</p>`;
                    }
                    return '';
                }).join('');

                const finalP2 = p2 && p2.trim().startsWith('#') ? p2 : '';

                return `<h2 class="lesson-subsection-title">æ´»å‹•å¼•å°å°æŠ€å·§</h2><div class="guidance-box">${contentHtml}</div>${finalP2}`;
            });

            // è™•ç†åˆ—è¡¨ (ä¸€èˆ¬æ­¥é©Ÿæˆ–æ³¨æ„äº‹é …)
            html = html.replace(/^- (.*)$/gm, '<div class="lesson-list-item">$1</div>');
            
            // å°‡å…§å®¹æ”¾å…¥ä¸€å€‹å°ˆæ¥­çš„å®¹å™¨
            return `<div class="space-y-3 leading-relaxed">${html}</div>`;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡å°ˆæ¥­è¨»è§£çš„ Markdown (å‹•ä½œèªªæ˜) æ ¼å¼åŒ–ç‚º HTML
        function formatNotesMarkdownToHtml(markdown) {
             if (typeof markdown !== 'string') {
                return '<p>ç„¡å°ˆæ¥­è¨»è§£å…§å®¹ã€‚</p>';
            }
            
            let html = markdown;
            
            // å°‡æ‰€æœ‰ç²—é«”æ¨™é¡Œè½‰ç‚º <strong> ä¸¦ä¿æŒç°¡æ½”çš„ note-list-item é¢¨æ ¼
            html = html.replace(/^[*+-]\s*(.*)$/gm, (match, p1) => {
                 // æ‰¾åˆ° **ç²—é«”** æ¨™é¡Œï¼Œä¸¦å°‡å…¶æ›¿æ›ç‚º HTML ç²—é«”
                 const renderedItem = p1.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                 // ä½¿ç”¨è‡ªå®šç¾© class ä¾†å¯¦ç¾æ¯å€‹é …ç›®ä¹‹é–“çš„é–“éš”
                 return `<div class="note-list-item">${renderedItem}</div>`;
            });
            
            // å°‡é€£çºŒæ›è¡Œè½‰æ›ç‚ºæ®µè½é–“éš”
            if (!html.includes('<div class="note-list-item"')) {
                html = html.split('\n\n').map(p => {
                    if (p.trim()) {
                         return `<p>${p.replace(/\n/g, '<br>')}</p>`;
                    }
                    return '';
                }).join('');
            }

            return html;
        }

    </script>
</body>
</html>
